---
title: 'Przewidywanie właściwości sekwencji biologicznych w oparciu o analizę n-gramów'
author: "Michał Burdukiewicz"
date: "28-06-2016"
output:
  ioslides_presentation: 
    css: shiny_paper.css
  fig_height: 5.5
fig_width: 9.5
widescreen: yes
bibliography: amyloids.bib
---
  
```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
library(DT)
library(knitr)
library(ggplot2)
library(grid)
library(gridExtra)
library(dplyr)
library(biogram)
library(reshape2)
library(plotly)

options(DT.options = list(iDisplayLength = 6, searching = TRUE))

size_mod <- -1

enc2df <- function(x)
  data.frame(Nazwa = names(x), Elementy = toupper(sapply(x, paste0, collapse = ", ")))

my_theme <- theme(
  axis.text = element_text(size=13 + size_mod),
  axis.title.x = element_text(size=14 + size_mod, vjust = -1),
  axis.title.y = element_text(size=14 + size_mod, vjust = 1),
  
  legend.background = element_rect(fill = "NA"),
  legend.key = element_rect(fill = "NA", color = "NA", size = 0.5),
  legend.position = "bottom",
  #uncomment for publications
  legend.key.size = unit(0.1, "inches"),
  legend.margin = unit(-0.25, "lines"),
  legend.text = element_text(size=13 + size_mod), 
  legend.title = element_text(size=15 + size_mod),
  
  panel.grid.major = element_line(color="grey", linetype = "dashed", size = 0.5),
  panel.grid.major = element_line(color="lightgrey", 
                                  linetype = "dashed", size = 0.5),
  panel.background = element_rect(fill = "transparent", color = "black"),
  
  plot.background=element_rect(fill = "transparent",
                               color = "transparent"),
  #uncomment for publications
  plot.margin = unit(rep(0.02, 4), "inches"),
  plot.title = element_text(size=20 + size_mod),
  
  strip.background = element_rect(fill = "NA", color = "NA"),
  strip.text = element_text(size=13 + size_mod, face = "bold")
)
```


## Białka amyloidowe

Białka związane z licznymi chorobami (np. choroby Alzheimera, Parkinsona, Creutzfeldta-Jakoba) tworzące szkodliwe agregaty.

Proces ten jest inicjowany w obrębie tzw. hot spots, krótkich (6-15 aminokwasów) podsekwencji, które występują we wszystkich białkach amyloidowych i formują specyficzne struktury $\beta$ typu "zamka błyskawicznego" (zipper-like).

## Hot spots

Zróżnicowanie budowy hot spots uniemożliwa opisanie ich konkretnych wzorcem, a w konsekwencji predykcję potencjalnych miejsc inicjacji agregacji amyloidowej w białku. 

<!-- ## Peptydy sygnałowe -->

<!-- Peptydy sygnałowe to krótkie (15-30 aminokwasów) N-końcowe sekwencje kierujące białko do sekrecji. -->

<!-- Powszechny model klasycznych peptydów sygnałowych zakłada, że rozpoczynają się one naładowanym dodatnio n-regionem, po którym występuje hydrofobowy h-region i c-region zakończony miejscem cięcia rozpoznawanym przez peptydazę sygnałową.  -->

<!-- ## Peptydy sygnałowe -->

<!-- <img src="static_figures/SP.png" align="middle"> -->

<!-- ## Peptydy sygnałowe -->

<!-- Analizy dużej liczby sekwencji reprezentujących szerokie spektrum zróżnicowanych taksonomicznie gatunków wskazują na dużą zmienność peptydów sygnałowych. -->

## n-gramy

Przykładowe sekwencje.  S - sekwencja, P - pozycja. 

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
sample_seq <- matrix(sample(c("A", "C", "G", "T"), 18, replace = TRUE), nrow = 3)
colnames(sample_seq) <- paste0("P", 1L:ncol(sample_seq))
rownames(sample_seq) <- paste0("S", 1L:nrow(sample_seq))


datatable(data.frame(sample_seq), 
          rownames = TRUE, filter = "none", 
          options = list(dom = 't'))

```

## n-gramy

Zliczenia 1-gramów.

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
unis <- count_ngrams(sample_seq, 1, c("A", "C", "G", "T"))
unis <- data.frame(as.matrix(unis))
colnames(unis) <- decode_ngrams(colnames(unis))
rownames(unis) <- paste0("S", 1L:nrow(sample_seq))

datatable(data.frame(sample_seq), 
          rownames = TRUE, filter = "none", 
          options = list(dom = 't'))
```

<!-- ## n-grams -->

<!-- ```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE} -->
<!-- unis <- count_ngrams(sample_seq, 2, c("A", "C", "G", "T")) -->
<!-- unis <- data.frame(as.matrix(unis)) -->
<!-- colnames(unis) <- decode_ngrams(colnames(unis)) -->
<!-- rownames(unis) <- paste0("S", 1L:nrow(sample_seq)) -->
<!-- kable(unis, caption = "Counts of 2-grams.", digits = 0) -->
<!-- ``` -->

<!-- ## n-grams -->

<!-- ```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE} -->
<!-- unis <- count_ngrams(sample_seq, 2, d = 1, c("A", "C", "G", "T")) -->
<!-- unis <- data.frame(as.matrix(unis)) -->
<!-- colnames(unis) <- sub("_", "|", decode_ngrams(colnames(unis))) -->
<!-- rownames(unis) <- paste0("S", 1L:nrow(sample_seq)) -->
<!-- kable(unis, caption = "Counts of 2-grams with distance 1.", digits = 0) -->
<!-- ``` -->

## Problemy analizy n-gramowej

n-gramy tworzą bardzo duże i trudne do analizy zbiory danych.

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
n <- 1:6
n_max <- 4^n

dat <- melt(sapply(2:5*5, function(i) i * n_max))
dat[["Var2"]] <- factor(dat[["Var2"]])
levels(dat[["Var2"]]) <- 2:5*5
colnames(dat) <- c("n", "L", "n_max")
dim_course <- ggplot(dat, aes(x = n, y = n_max, fill = L, col = L)) + 
  geom_line(linetype="dotted", size=1.5) + 
  geom_point(size=7, shape=21) +
  scale_x_continuous(breaks = 0L:6) +
  scale_y_continuous("Całkowita liczba n-gramów") +
  my_theme

ggplotly(dim_course, tooltip = c("x", "y"))
```

## Redukcja wymiarów - zmniejszenie alfabetu

W przypadku alfabetu aminokwasowego zmniejszenie wielkości alfabetu skutkuje mniejszą liczbą potencjalnych n-gramów.

$n_{\text{max}} = L \times m^n$

$n_{\text{max}}$: liczba n-gramów.  
$L$: długość sekwencji.  
$m$: wielkość alfabetu.  
$n$: długość n-gramu.

## Redukcja wymiarów - wybór n-gramów

n-gramy filtrowane są zwykle przy wykorzystaniu testów permutacyjnych. 

Podczas testu permutacyjnego oznaczenia klas są losowo mieszane, a uzyskaną wartość danej statystyki (w tym przypadku information gain) porównuje się z wartością tej statystyki dla danych oryginalnych.

## Redukcja wymiarów - wybór n-gramów

$      
\textnormal{p-value} = \frac{N_{T_P > T_R}}{N}
$

gdzie $N_{T_P > T_R}$ to liczba przypadków kiedy $T_P$ (permutowana statystyka testowa) miała wartość bardziej skrajną niż $T_R$ (statystyka testowa dla niespermutowanych danych).

## Redukcja wymiarów - wybór n-gramów

Testy permutacyjne są bardzo wymagające obliczeniowo (zwłaszcza, kiedy konieczna jest precyzyjna estymacja małych p-wartości, poniważ liczba permutacji jest odwrotnie proporcjonalna do przedziału między p-wartościami). Dlatego też opracowano Quick Permutation Test, który pozwala wielokrotnie szybciej filtrować n-gramy.


## Amyloidy - redukcja alfabetu

Stworzono 524 284 zredukowane alfabety o różnych długościach (od trzech do sześciu grup) wykorzystując metodę grupowań Warda na wybranych cechach fizykochemicznych z basy AAIndex.

## Najlepsze kodowanie

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
datatable(enc2df(list(`1` = "g", 
                  `2` = c("k", "p", "r"), 
                  `3` = c("i", "l", "v"), 
                  `4` = c("f", "w", "y"), 
                  `5` = c("a", "c", "h", "m"), 
                  `6` = c("d", "e", "n", "q", "s", "t"))), 
          rownames = FALSE, filter = "none", 
          options = list(dom = 't')) 
```


## Najlepsze kodowanie

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
datatable(enc2df(list(`1` = "g", 
                  `2` = c("k", "p", "r"), 
                  `3` = c("i", "l", "v"), 
                  `4` = c("f", "w", "y"), 
                  `5` = c("a", "c", "h", "m"), 
                  `6` = c("d", "e", "n", "q", "s", "t"))), 
          rownames = FALSE, filter = "none", 
          options = list(dom = 't')) %>% 
  formatStyle(
    'Elementy',
    backgroundColor = styleEqual("K, P, R", 'aquamarine')
  )
```

Aminowaksy K, P, R nie powinny występować w obrębie hot spots [@paz_sequence_2004].

## Najlepsze kodowanie

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
datatable(enc2df(list(`1` = "g", 
                  `2` = c("k", "p", "r"), 
                  `3` = c("i", "l", "v"), 
                  `4` = c("f", "w", "y"), 
                  `5` = c("a", "c", "h", "m"), 
                  `6` = c("d", "e", "n", "q", "s", "t"))), 
          rownames = FALSE, filter = "none", 
          options = list(dom = 't')) %>% 
  formatStyle(
    'Elementy',
    backgroundColor = styleEqual("K, P, R", 'aquamarine')
  )
```

Najlepsze kodowanie wykorzystano do wyuczenia programu AmyloGram, opartego na n-gramach predyktora amyloidogenności.

## Informatywne n-gramy

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE,fig.width=10}
ngram_freq <- read.csv("ngram_freq.csv")

ngram_freq_plot <- mutate(ngram_freq, decoded_name = gsub("_", "|", decoded_name)) %>%
  mutate(decoded_name = factor(decoded_name, levels = as.character(decoded_name)),
         amyloid = diff_freq > 0) %>%
  melt() %>%
  filter(variable %in% c("pos", "neg"),
         association != "Not found") %>%
  droplevels %>%
  mutate(variable = factor(variable, labels = c("Amyloidogenny", "Nieamyloidogenny"))) %>% 
  rename(Frequency = value) %>% 
  droplevels

ngram_plot <- ggplot(ngram_freq_plot, aes(x = decoded_name, y = Frequency)) +
  geom_bar(aes(fill = variable), position = "dodge", stat = "identity") +
  geom_point(data = group_by(ngram_freq_plot, decoded_name)  %>% filter(Frequency == max(Frequency)),
             aes(y = Frequency + 0.002, shape = association)) +
  scale_fill_manual("", values = c("gold", "darkmagenta")) +
  scale_shape_manual("Motif:", values = c(16, 17)) +
  scale_y_continuous("Frequency") +
  scale_x_discrete("") +
  my_theme +
  theme(panel.grid.major.y = element_line(color = "lightgrey", size = 0.5)) 

ggplotly(ngram_plot, tooltip = "y")
```

## Benchmark

```{r, echo = FALSE, message = FALSE, results='asis',warning=FALSE}
benchmark_dat <- structure(list(classifier = structure(c(4L, 3L, 1L, 2L), .Label = c("appnn", 
"class14592_10", "FoldAmyloid", "PASTA2"), class = "factor"), 
    AUC = c(0.854996271439225, 0.735098185433756, 0.834302759134974, 
    0.897153865274671), MCC = c(0.429123592940917, 0.45255292317694, 
    0.582260193831285, 0.630749412736651), Sens = c(0.38255033557047, 
    0.751677852348993, 0.885906040268456, 0.865771812080537), 
    Spec = c(0.951851851851852, 0.718518518518519, 0.722222222222222, 
    0.788888888888889), pos = c(NA, NA, NA, 10L), nice_name = structure(c(4L, 
    3L, 2L, 1L), .Label = c("14592", "appnn", "FoldAmyloid", 
    "PASTA2"), class = "factor")), .Names = c("classifier", "AUC", 
"MCC", "Sens", "Spec", "pos", "nice_name"), row.names = c(1L, 
2L, 3L, 5L), class = "data.frame")

benchmark_dat %>% 
  mutate(classifier = as.character(classifier)) %>% 
  mutate(classifier = ifelse(classifier == "class14592_10", "AmyloGram", classifier)) %>% 
  rename(Software = classifier, Sensitivity = Sens, Specificity = Spec) %>% 
  select(1L:5) %>% 
  datatable(rownames = FALSE, filter = "none", 
          options = list(dom = 't')) %>% 
  formatRound(2L:5, 4) %>% 
  formatStyle(
    'AUC',
    backgroundColor = styleInterval(c(0.897, 1), c('white', 'aquamarine', 'white'))
  ) %>%
  formatStyle(
    'MCC',
    backgroundColor = styleInterval(c(0.63, 1), c('white', 'aquamarine', 'white'))
  ) %>% 
  formatStyle(
    'Sensitivity',
    backgroundColor = styleInterval(c(0.88, 1), c('white', 'aquamarine', 'white'))
  ) %>% 
  formatStyle(
    'Specificity',
    backgroundColor = styleInterval(c(0.94, 1), c('white', 'aquamarine', 'white'))
  )

```

Porównanie AmyloGramu z APPNN [@familia_prediction_2015], PASTA2 [@walsh_pasta_2014] i FoldAmyloid [@garbuzynskiy_foldamyloid:_2010].

## Podsumowanie

Analiza metodami n-gramowymi pozwala na precyzyjniejsze przewidywanie właściwości sekwencji aminokwasowych.

[AmyloGram](www.smorfland.uni.wroc.pl/amylogram)  
[signalHsmm](www.smorfland.uni.wroc.pl/signalHsmm)

## References